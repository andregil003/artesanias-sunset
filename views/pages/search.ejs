<!-- views/pages/search.ejs -->
<main id="main-content">
    <div class="container">
        <!-- Header de b√∫squeda -->
        <section class="catalog-header section text-justify pl-custom">
            <h1>Resultados de B√∫squeda</h1>
            <p>Buscaste: <strong>"<%= searchQuery %>"</strong></p>
            <% if (pagination.showAll) { %>
                <p class="results-count">Mostrando todos los <%= resultsCount %> resultados</p>
            <% } else { %>
                <p class="results-count">
                    Mostrando <%= products.length %> de <%= resultsCount %> resultados
                    (P√°gina <%= pagination.currentPage %> de <%= pagination.totalPages %>)
                </p>
            <% } %>
        </section>

        <!-- Grid de productos -->
        <section class="products-section section">
            <div class="products-grid" id="products-grid">
                <% if (products && products.length > 0) { %>
                    <% products.forEach(product => { %>
                        <div class="product-card">
                            <div class="product-image">
                                <% if (product.image_url) { %>
                                    <img src="<%= product.image_url %>" alt="<%= product.product_name %>">
                                <% } else { %>
                                    <div class="image-placeholder">üì∑</div>
                                <% } %>
                                <% if (product.available_stock === 0) { %>
                                    <div class="out-of-stock-badge">Agotado</div>
                                <% } %>
                            </div>
                            <div class="product-info">
                                <p class="product-category"><%= product.category_name %></p>
                                <h3><%= product.product_name %></h3>
                                <p class="product-description"><%= product.description ? product.description.substring(0, 100) + '...' : 'Sin descripci√≥n' %></p>
                                <p class="product-price">Q<%= parseFloat(product.price).toFixed(2) %></p>
                                <p class="product-stock">
                                    <% if (product.available_stock > 10) { %>
                                        ‚úÖ Disponible
                                    <% } else if (product.available_stock > 0) { %>
                                        ‚ö†Ô∏è √öltimas <%= product.available_stock %> unidades
                                    <% } else { %>
                                        ‚ùå Agotado
                                    <% } %>
                                </p>
                                <div class="product-actions">
                                    <a href="/product/<%= product.product_id %>" class="btn btn-primary">Ver Detalles</a>
                                    <% if (product.available_stock > 0) { %>
                                        <button class="btn add-to-cart" data-id="<%= product.product_id %>">Agregar</button>
                                    <% } else { %>
                                        <button class="btn btn-disabled" disabled>Agotado</button>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    <% }); %>
                <% } else { %>
                    <div class="no-products">
                        <h3>No se encontraron resultados</h3>
                        <p>Intenta con diferentes palabras clave o <a href="/catalog">ver todos los productos</a></p>
                    </div>
                <% } %>
            </div>
        </section>

        <!-- Paginaci√≥n -->
        <% if (!pagination.showAll && pagination.totalPages > 1 && products.length > 0) { %>
        <div class="pagination-controls">
            <% if (pagination.hasPrev) { %>
                <a href="/search?q=<%= encodeURIComponent(searchQuery) %>&page=<%= pagination.currentPage - 1 %>" class="pagination-btn">‚Üê</a>
            <% } %>

            <div class="pagination-numbers">
                <%
                const maxVisible = 5;
                let startPage = Math.max(1, pagination.currentPage - 2);
                let endPage = Math.min(pagination.totalPages, startPage + maxVisible - 1);

                if (endPage - startPage < maxVisible - 1) {
                    startPage = Math.max(1, endPage - maxVisible + 1);
                }
                %>

                <% if (startPage > 1) { %>
                    <a href="/search?q=<%= encodeURIComponent(searchQuery) %>&page=1" class="pagination-number">1</a>
                    <% if (startPage > 2) { %>
                        <span class="pagination-dots">...</span>
                    <% } %>
                <% } %>

                <% for (let i = startPage; i <= endPage; i++) { %>
                    <a href="/search?q=<%= encodeURIComponent(searchQuery) %>&page=<%= i %>"
                       class="pagination-number <%= i === pagination.currentPage ? 'active' : '' %>">
                        <%= i %>
                    </a>
                <% } %>

                <% if (endPage < pagination.totalPages) { %>
                    <% if (endPage < pagination.totalPages - 1) { %>
                        <span class="pagination-dots">...</span>
                    <% } %>
                    <a href="/search?q=<%= encodeURIComponent(searchQuery) %>&page=<%= pagination.totalPages %>" class="pagination-number">
                        <%= pagination.totalPages %>
                    </a>
                <% } %>
            </div>

            <% if (pagination.hasNext) { %>
                <a href="/search?q=<%= encodeURIComponent(searchQuery) %>&page=<%= pagination.currentPage + 1 %>" class="pagination-btn">‚Üí</a>
            <% } %>
        </div>

        <div class="view-all-section">
            <a href="/search?q=<%= encodeURIComponent(searchQuery) %>&all=true" class="btn-view-all">Ver todos</a>
        </div>
        <% } else if (pagination.showAll && products.length > 0) { %>
        <div class="view-all-section">
            <a href="/search?q=<%= encodeURIComponent(searchQuery) %>" class="btn-view-all">‚Üê Volver a paginaci√≥n</a>
        </div>
        <% } %>

        <!-- Informaci√≥n adicional -->
        <section class="catalog-info section text-center">
            <h2>¬øNo encuentras lo que buscas?</h2>
            <p>Cont√°ctanos por WhatsApp para consultar sobre productos personalizados</p>
            <a href="https://wa.me/50241298574" class="btn btn-primary" target="_blank">
                Consultar por WhatsApp
            </a>
        </section>
    </div>
</main>