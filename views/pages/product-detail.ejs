<!-- public/views/pages/product-detail.ejs -->
<main id="main-content">
  <div class="container">
    <nav class="breadcrumb">
      <a href="/">Inicio</a> > 
      <a href="/catalog">Catálogo</a> > 
      <% if (product.category_name && product.category_slug) { %>
        <a href="/category/<%= product.category_slug %>"><%= product.category_name %></a> > 
      <% } %>
      <span><%= product.product_name %></span>
    </nav>

    <div class="product-detail">
      <div class="product-image-section">
        <div class="main-image">
          <% if (product.image_url) { %>
            <img src="<%= product.image_url %>" alt="<%= product.product_name %>">
          <% } else { %>
            <div class="image-placeholder">
              <i class="fa-solid fa-image"></i>
            </div>
          <% } %>
        </div>
      </div>

      <div class="product-info-section">
        <h1 class="product-title"><%= product.product_name %></h1>
        
        <div class="product-price-section">
          <div>
            <span class="current-price">Q<%= parseFloat(product.price).toFixed(2) %></span>
            <span style="color: #999; font-size: 1.1rem; margin-left: 10px;">
              ≈ $<%= (parseFloat(product.price) * 0.128).toFixed(2) %> USD
            </span>
          </div>
          <% if (product.wholesale_price && parseFloat(product.wholesale_price) < parseFloat(product.price)) { %>
            <span class="wholesale-note">
              Precio mayorista: Q<%= parseFloat(product.wholesale_price).toFixed(2) %>
              <small style="color: #999;">
                (≈ $<%= (parseFloat(product.wholesale_price) * 0.128).toFixed(2) %> USD)
              </small>
            </span>
          <% } %>
        </div>

        <div class="product-description">
          <h3>Descripción</h3>
          <p><%= product.description %></p>
        </div>

        <% if (product.sizesArray && product.sizesArray.length > 0) { %>
        <div class="product-options">
          <h3>Tallas Disponibles</h3>
          <div class="size-options">
            <% product.sizesArray.forEach(size => { %>
              <button class="size-btn" data-size="<%= size %>"><%= size %></button>
            <% }); %>
          </div>
        </div>
        <% } %>

        <% if (product.colorsArray && product.colorsArray.length > 0) { %>
        <div class="product-options">
          <h3>Colores Disponibles</h3>
          <div class="color-options">
            <% product.colorsArray.forEach(color => { %>
              <button class="color-btn" data-color="<%= color %>"><%= color %></button>
            <% }); %>
          </div>
        </div>
        <% } %>

        <% if (product.materialsArray && product.materialsArray.length > 0) { %>
        <div class="product-options">
          <h3>Materiales Disponibles</h3>
          <div class="material-options">
            <% product.materialsArray.forEach(material => { %>
              <button class="material-btn" data-material="<%= material %>"><%= material %></button>
            <% }); %>
          </div>
        </div>
        <% } %>

        <div class="purchase-section">
          <div class="quantity-section">
            <label for="quantity">Cantidad:</label>
            <div class="quantity-controls">
              <button type="button" id="decrease-qty">-</button>
              <input type="number" id="quantity" value="1" min="1" max="<%= product.availableStock || 10 %>">
              <button type="button" id="increase-qty">+</button>
            </div>
          </div>

          <% if (product.availableStock > 0) { %>
            <button class="btn-add-to-cart" data-product-id="<%= product.product_id %>">
              Agregar al Carrito
            </button>
          <% } else { %>
            <button class="btn-add-to-cart" disabled style="opacity: 0.5; cursor: not-allowed;">
              Sin Stock
            </button>
          <% } %>

          <a href="https://wa.me/<%= process.env.WHATSAPP_NUMBER || '50241298574' %>?text=<%= encodeURIComponent('Hola, me interesa el producto: ' + product.product_name) %>" 
             class="btn-whatsapp" target="_blank">
            <i class="fa-brands fa-whatsapp"></i> Consultar por WhatsApp
          </a>
        </div>

        <div class="product-details">
          <h3>Información del Producto</h3>
          <ul>
            <li><strong>Categoría:</strong> <%= product.category_name || 'Sin categoría' %></li>
            <li><strong>Hecho a mano:</strong> Sí</li>
            <li><strong>Origen:</strong> Guatemala</li>
            <li><strong>Stock:</strong> 
              <% if (product.availableStock > 10) { %>
                <i class="fa-solid fa-circle-check"></i> <%= product.availableStock %> disponibles
              <% } else if (product.availableStock > 0) { %>
                <i class="fa-solid fa-triangle-exclamation"></i> ¡Solo quedan <%= product.availableStock %>!
              <% } else { %>
                <i class="fa-solid fa-circle-xmark"></i> Agotado
              <% } %>
            </li>
          </ul>
        </div>

        <% if (product.reviews && product.reviews.length > 0) { %>
        <div class="product-reviews">
          <h3>Reseñas de Clientes</h3>
          <div class="average-rating">
            <span class="rating-stars">
              <i class="fa-solid fa-star"></i>
            </span>
            <span class="rating-value"><%= product.averageRating %> / 5</span>
            <span class="rating-count">(<%= product.reviews.length %> reseñas)</span>
          </div>
          <div class="reviews-list">
            <% product.reviews.slice(0, 3).forEach(review => { %>
              <div class="review-item">
                <div class="review-header">
                  <strong><%= review.customer_name %></strong>
                  <span class="review-rating">
                    <% for (let i = 0; i < review.rating; i++) { %>
                      <i class="fa-solid fa-star"></i>
                    <% } %>
                  </span>
                </div>
                <p class="review-text"><%= review.review_text %></p>
                <% if (review.is_verified_purchase) { %>
                  <span class="verified-badge">
                    <i class="fa-solid fa-circle-check"></i> Compra verificada
                  </span>
                <% } %>
              </div>
            <% }); %>
          </div>
        </div>
        <% } %>
      </div>
    </div>
  </div>
</main>