<!-- public/views/admin/pages/products-form.ejs -->
<header class="admin-header">
    <div class="header-left">
        <h1 class="page-title"><%= isEdit ? 'Editar Producto' : 'Nuevo Producto' %></h1>
    </div>
    <div class="header-right">
        <a href="/admin/products" class="btn-secondary">
            <i class="fa-solid fa-arrow-left"></i> Volver a productos
        </a>
    </div>
</header>

<main class="admin-content">
    
    <div class="form-container">
        <form id="product-form" method="POST" action="<%= isEdit ? `/admin/products/${product.product_id}?_method=PUT` : '/admin/products' %>">
            
            <div class="form-section">
                <h3 class="section-title">Información Básica</h3>
                
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="product_name">Nombre del Producto *</label>
                        <input 
                            type="text" 
                            id="product_name" 
                            name="product_name" 
                            value="<%= product ? product.product_name : '' %>"
                            required
                            class="form-input"
                            placeholder="Ej: Huipil Tradicional de Chichicastenango"
                        >
                    </div>
                    
                    <div class="form-group">
                        <label for="category_id">Categoría *</label>
                        <select id="category_id" name="category_id" required class="form-select">
                            <option value="">Selecciona una categoría</option>
                            <% categories.forEach(cat => { %>
                                <option 
                                    value="<%= cat.category_id %>" 
                                    <%= product && product.category_id === cat.category_id ? 'selected' : '' %>
                                >
                                    <%= cat.category_name %>
                                </option>
                            <% }); %>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="price">Precio (Q) *</label>
                        <input 
                            type="number" 
                            id="price" 
                            name="price" 
                            value="<%= product ? product.price : '' %>"
                            step="0.01"
                            min="0"
                            required
                            class="form-input"
                            placeholder="0.00"
                        >
                    </div>
                    
                    <div class="form-group">
                        <label for="stock">Stock</label>
                        <input 
                            type="number" 
                            id="stock" 
                            name="stock" 
                            value="<%= product ? product.stock : 0 %>"
                            min="0"
                            class="form-input"
                            placeholder="0"
                        >
                        <small class="form-help">Dejar en 0 si el producto tiene variantes</small>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="description">Descripción</label>
                        <textarea 
                            id="description" 
                            name="description" 
                            rows="5"
                            class="form-textarea"
                            placeholder="Descripción detallada del producto..."
                        ><%= product ? product.description : '' %></textarea>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="temp_image_url">Imagen del Producto</label>
                        
                        <input type="hidden" id="image_url" name="image_url" value="">
                        
                        <input 
                            type="url" 
                            id="temp_image_url" 
                            class="form-input" 
                            placeholder="Pega la URL de una imagen aquí..."
                            style="margin-bottom: 8px;"
                        >
                        <small class="form-help">
                            Formatos: JPG, PNG, WEBP, GIF - La imagen se cargará automáticamente
                        </small>
                        
                        <div id="current-preview-container" style="margin-top: 20px; display: none;">
                            <p style="display: block; margin-bottom: 8px; font-weight: 600;">Imagen actual:</p>
                            <div class="current-image-wrapper">
                                <img 
                                    id="current-image" 
                                    src="" 
                                    alt="Imagen actual" 
                                    style="max-width: 400px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: block; margin-bottom: 12px;"
                                >
                                <div style="display: flex; gap: 10px;">
                                    <button type="button" id="btn-edit-image" class="btn-primary btn-small">
                                        <i class="fa-solid fa-crop-simple"></i> Editar Imagen
                                    </button>
                                    <button type="button" id="btn-remove-image" class="btn-danger btn-small">
                                        <i class="fa-solid fa-trash"></i> Eliminar
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <% if (product && product.image_url) { %>
                        <script>
                        document.addEventListener('DOMContentLoaded', function() {
                            const existingUrl = '<%= product.image_url %>';
                            if (existingUrl) {
                                document.getElementById('image_url').value = existingUrl;
                                document.getElementById('current-image').src = existingUrl;
                                document.getElementById('current-preview-container').style.display = 'block';
                            }
                        });
                        </script>
                        <% } %>
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h3 class="section-title">Estado del Producto</h3>
                
                <div class="form-group">
                    <label class="checkbox-label">
                        <input 
                            type="checkbox" 
                            id="is_active"
                            name="is_active" 
                            value="true"
                            <%= !product || product.is_active ? 'checked' : '' %>
                            class="form-checkbox"
                        >
                        <span>Producto activo (visible en la tienda)</span>
                    </label>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn-primary btn-large">
                    <% if (isEdit) { %>
                        <i class="fa-solid fa-save"></i> Guardar Cambios
                    <% } else { %>
                        <i class="fa-solid fa-plus"></i> Crear Producto
                    <% } %>
                </button>
                <a href="/admin/products" class="btn-secondary btn-large">
                    Cancelar
                </a>
            </div>
            
        </form>
    </div>
    
</main>

<div id="image-editor-modal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3><i class="fa-solid fa-crop-simple"></i> Editar Imagen del Producto</h3>
            <button type="button" class="modal-close" aria-label="Cerrar">&times;</button>
        </div>
        
        <div class="modal-body">
            <div class="editor-container">
                <div class="editor-column">
                    <h4>Ajustar encuadre</h4>
                    <div class="cropper-wrapper">
                        <img id="crop-image" src="" alt="Imagen para recortar">
                    </div>
                    
                    <div class="editor-controls">
                        <div class="controls-row">
                            <button type="button" class="btn-control" data-action="rotate-left" title="Rotar izquierda">
                                <i class="fa-solid fa-rotate-left"></i>
                            </button>
                            <button type="button" class="btn-control" data-action="rotate-right" title="Rotar derecha">
                                <i class="fa-solid fa-rotate-right"></i>
                            </button>
                            <button type="button" class="btn-control" data-action="flip-horizontal" title="Voltear horizontal">
                                <i class="fa-solid fa-arrows-left-right"></i>
                            </button>
                            <button type="button" class="btn-control" data-action="flip-vertical" title="Voltear vertical">
                                <i class="fa-solid fa-arrows-up-down"></i>
                            </button>
                        </div>
                        <div class="controls-row">
                            <button type="button" class="btn-control" data-action="zoom-in" title="Acercar">
                                <i class="fa-solid fa-search-plus"></i>
                            </button>
                            <button type="button" class="btn-control" data-action="zoom-out" title="Alejar">
                                <i class="fa-solid fa-search-minus"></i>
                            </button>
                            <button type="button" class="btn-control" data-action="reset" title="Reiniciar">
                                <i class="fa-solid fa-rotate"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="aspect-ratio-selector">
                        <span class="ratio-label">Proporción:</span>
                        <button type="button" class="btn-ratio active" data-ratio="1">Cuadrado (1:1)</button>
                        <button type="button" class="btn-ratio" data-ratio="1.33">4:3</button>
                        <button type="button" class="btn-ratio" data-ratio="1.77">16:9</button>
                        <button type="button" class="btn-ratio" data-ratio="0">Libre</button>
                    </div>
                </div>
                
                <div class="preview-column">
                    <h4>Vista previa del catálogo</h4>
                    
                    <div class="preview-card">
                        <span class="preview-card-label"><i class="fa-solid fa-mobile-screen"></i> Móvil</span>
                        <div class="product-card-preview mobile">
                            <div class="preview-image-container">
                                <img id="preview-mobile" src="" alt="Preview móvil">
                            </div>
                            <div class="preview-info">
                                <h5>Nombre del Producto</h5>
                                <p class="preview-price">Q 150.00</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="preview-card">
                        <span class="preview-card-label"><i class="fa-solid fa-desktop"></i> Desktop</span>
                        <div class="product-card-preview desktop">
                            <div class="preview-image-container">
                                <img id="preview-desktop" src="" alt="Preview desktop">
                            </div>
                            <div class="preview-info">
                                <h5>Nombre del Producto</h5>
                                <p class="preview-price">Q 150.00</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="modal-footer">
            <button type="button" id="btn-cancel-crop" class="btn-secondary btn-large">
                Cancelar
            </button>
            <button type="button" id="btn-apply-crop" class="btn-primary btn-large">
                <i class="fa-solid fa-check"></i> Aplicar y Guardar
            </button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
<script src="/js/admin-products-form.js"></script>