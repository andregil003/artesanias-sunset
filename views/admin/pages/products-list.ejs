<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    
    <!-- CSS Base -->
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/admin.css">
    
    <!-- jQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
</head>
<body class="admin-body">
    
    <!-- Sidebar -->
    <aside class="admin-sidebar">
        <div class="sidebar-header">
            <h2>üåÖ</h2>
            <p>Artesan√≠as Sunset</p>
        </div>
        
        <nav class="sidebar-nav">
            <a href="/admin" class="nav-item">
                <span class="nav-icon">üìä</span>
                <span class="nav-text">Dashboard</span>
            </a>
            
            <a href="/admin/products" class="nav-item active">
                <span class="nav-icon">üì¶</span>
                <span class="nav-text">Productos</span>
            </a>
            
            <a href="/admin/categories" class="nav-item">
                <span class="nav-icon">üè∑Ô∏è</span>
                <span class="nav-text">Categor√≠as</span>
            </a>
            
            <a href="/admin/orders" class="nav-item">
                <span class="nav-icon">üõí</span>
                <span class="nav-text">√ìrdenes</span>
            </a>
            
            <div class="nav-divider"></div>
            
            <a href="/analytics" class="nav-item">
                <span class="nav-icon">üìà</span>
                <span class="nav-text">Anal√≠ticas</span>
            </a>
            
            <a href="/" class="nav-item">
                <span class="nav-icon">üè†</span>
                <span class="nav-text">Ver Tienda</span>
            </a>
        </nav>
    </aside>
    
    <!-- Main Content -->
    <div class="admin-main">
        <!-- Header -->
        <header class="admin-header">
            <div class="header-left">
                <h1 class="page-title">Productos (<%= pagination.totalProducts %>)</h1>
            </div>
            <div class="header-right">
                <a href="/admin/products/new" class="btn-primary">‚ûï Nuevo Producto</a>
            </div>
        </header>
        
        <!-- Content Area -->
        <main class="admin-content">
            
            <!-- Filtros avanzados -->
            <div class="filters-section">
                <form method="GET" action="/admin/products" class="filters-form" id="filters-form">
                    <!-- B√∫squeda -->
                    <div class="filter-group">
                        <input 
                            type="text" 
                            name="search" 
                            placeholder="üîç Buscar por nombre..."
                            value="<%= filters.search || '' %>"
                            class="filter-input search-input"
                        >
                    </div>
                    
                    <!-- Categor√≠a -->
                    <div class="filter-group">
                        <select name="category" class="filter-select">
                            <option value="">üì¶ Todas las categor√≠as</option>
                            <% categories.forEach(cat => { %>
                                <option value="<%= cat.category_name %>" <%= filters.category === cat.category_name ? 'selected' : '' %>>
                                    <%= cat.category_name %>
                                </option>
                            <% }); %>
                        </select>
                    </div>
                    
                    <!-- Estado -->
                    <div class="filter-group">
                        <select name="status" class="filter-select">
                            <option value="">üîò Todos los estados</option>
                            <option value="active" <%= filters.status === 'active' ? 'selected' : '' %>>‚úÖ Activos</option>
                            <option value="inactive" <%= filters.status === 'inactive' ? 'selected' : '' %>>‚ùå Inactivos</option>
                        </select>
                    </div>
                    
                    <!-- Stock -->
                    <div class="filter-group">
                        <select name="stock" class="filter-select">
                            <option value="">üìä Todo el stock</option>
                            <option value="in-stock" <%= filters.stockFilter === 'in-stock' ? 'selected' : '' %>>‚úÖ En stock</option>
                            <option value="low-stock" <%= filters.stockFilter === 'low-stock' ? 'selected' : '' %>>‚ö†Ô∏è Stock bajo</option>
                            <option value="out-of-stock" <%= filters.stockFilter === 'out-of-stock' ? 'selected' : '' %>>‚ùå Agotado</option>
                        </select>
                    </div>
                    
                    <!-- Ordenamiento -->
                    <div class="filter-group">
                        <select name="sort" class="filter-select">
                            <option value="newest" <%= filters.sortBy === 'newest' ? 'selected' : '' %>>üÜï M√°s recientes</option>
                            <option value="oldest" <%= filters.sortBy === 'oldest' ? 'selected' : '' %>>üïê M√°s antiguos</option>
                            <option value="price-asc" <%= filters.sortBy === 'price-asc' ? 'selected' : '' %>>üí∞ Precio ‚¨ÜÔ∏è</option>
                            <option value="price-desc" <%= filters.sortBy === 'price-desc' ? 'selected' : '' %>>üí∞ Precio ‚¨áÔ∏è</option>
                            <option value="name" <%= filters.sortBy === 'name' ? 'selected' : '' %>>üî§ A-Z</option>
                            <option value="name-desc" <%= filters.sortBy === 'name-desc' ? 'selected' : '' %>>üî§ Z-A</option>
                        </select>
                    </div>
                    
                    <!-- Botones -->
                    <button type="submit" class="btn-filter">Filtrar</button>
                    <a href="/admin/products" class="btn-reset">Limpiar filtros</a>
                </form>
            </div>

            <!-- Informaci√≥n de resultados -->
            <div class="results-info">
                <% if (pagination.showAll) { %>
                    üìã Mostrando todos los <%= pagination.totalProducts %> productos
                <% } else { %>
                    üìã Mostrando <%= products.length %> de <%= pagination.totalProducts %> productos
                    (P√°gina <%= pagination.currentPage %> de <%= pagination.totalPages %>)
                <% } %>
            </div>

            <!-- Tabla de productos -->
            <div class="table-container">
                <% if (products.length > 0) { %>
                    <table class="products-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Imagen</th>
                                <th>Nombre</th>
                                <th>Categor√≠a</th>
                                <th>Precio</th>
                                <th>Stock</th>
                                <th>Variantes</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% products.forEach(product => { %>
                                <tr data-product-id="<%= product.product_id %>">
                                    <td>#<%= product.product_id %></td>
                                    <td>
                                        <% if (product.image_url) { %>
                                            <img src="<%= product.image_url %>" alt="<%= product.product_name %>" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">
                                        <% } else { %>
                                            <span style="font-size: 2rem;">üì∑</span>
                                        <% } %>
                                    </td>
                                    <td class="product-name"><%= product.product_name %></td>
                                    <td><%= product.category_name || 'Sin categor√≠a' %></td>
                                    <td class="product-price">Q<%= parseFloat(product.price).toFixed(2) %></td>
                                    <td>
                                        <span class="stock-badge <%= product.total_stock < 5 ? 'low-stock' : '' %>">
                                            <%= product.total_stock %>
                                        </span>
                                    </td>
                                    <td><%= product.variant_count %></td>
                                    <td>
                                        <% if (product.is_active) { %>
                                            <span class="status-badge active">Activo</span>
                                        <% } else { %>
                                            <span class="status-badge inactive">Inactivo</span>
                                        <% } %>
                                    </td>
                                    <td class="actions-cell">
                                        <a href="/admin/products/<%= product.product_id %>/edit" class="btn-action edit" title="Editar">
                                            ‚úèÔ∏è
                                        </a>
                                        <button class="btn-action delete" data-id="<%= product.product_id %>" title="Desactivar">
                                            üóëÔ∏è
                                        </button>
                                    </td>
                                </tr>
                            <% }); %>
                        </tbody>
                    </table>
                <% } else { %>
                    <div class="empty-state">
                        <p>üì≠ No se encontraron productos con los filtros aplicados</p>
                        <a href="/admin/products" class="btn-primary">Ver todos</a>
                    </div>
                <% } %>
            </div>

            <!-- Paginaci√≥n -->
            <% 
            function buildPaginationUrl(page) {
                let url = `/admin/products?page=${page}`;
                if (filters.search) url += `&search=${encodeURIComponent(filters.search)}`;
                if (filters.category) url += `&category=${encodeURIComponent(filters.category)}`;
                if (filters.status) url += `&status=${filters.status}`;
                if (filters.stockFilter) url += `&stock=${filters.stockFilter}`;
                if (filters.sortBy) url += `&sort=${filters.sortBy}`;
                if (filters.minPrice > 0) url += `&min_price=${filters.minPrice}`;
                if (filters.maxPrice) url += `&max_price=${filters.maxPrice}`;
                return url;
            }
            %>
            
            <% if (!pagination.showAll && pagination.totalPages > 1 && products.length > 0) { %>
            <div class="pagination-controls">
                <% if (pagination.hasPrev) { %>
                    <a href="<%= buildPaginationUrl(pagination.currentPage - 1) %>" class="pagination-btn">‚Üê</a>
                <% } %>
                
                <div class="pagination-numbers">
                    <% 
                    const maxVisible = 5;
                    let startPage = Math.max(1, pagination.currentPage - 2);
                    let endPage = Math.min(pagination.totalPages, startPage + maxVisible - 1);
                    
                    if (endPage - startPage < maxVisible - 1) {
                        startPage = Math.max(1, endPage - maxVisible + 1);
                    }
                    %>
                    
                    <% for (let i = startPage; i <= endPage; i++) { %>
                        <a href="<%= buildPaginationUrl(i) %>" 
                           class="pagination-number <%= i === pagination.currentPage ? 'active' : '' %>">
                            <%= i %>
                        </a>
                    <% } %>
                    
                    <% if (endPage < pagination.totalPages) { %>
                        <% if (endPage < pagination.totalPages - 1) { %>
                            <span class="pagination-dots">...</span>
                        <% } %>
                        <a href="<%= buildPaginationUrl(pagination.totalPages) %>" class="pagination-number">
                            <%= pagination.totalPages %>
                        </a>
                    <% } %>
                </div>
                
                <% if (pagination.hasNext) { %>
                    <a href="<%= buildPaginationUrl(pagination.currentPage + 1) %>" class="pagination-btn">‚Üí</a>
                <% } %>
            </div>

            <div class="view-all-section">
                <a href="<%= buildPaginationUrl(1).replace('page=1', 'all=true') %>" class="btn-secondary">
                    üìã Ver todos los productos
                </a>
            </div>
            <% } else if (pagination.showAll && products.length > 0) { %>
            <div class="view-all-section">
                <a href="/admin/products" class="btn-secondary">
                    ‚Üê Volver a paginaci√≥n
                </a>
            </div>
            <% } %>

        </main>
    </div>
    
    <!-- Scripts -->
    <script src="/js/admin.js"></script>
    <script src="/js/admin-products.js"></script>
</body>
</html>